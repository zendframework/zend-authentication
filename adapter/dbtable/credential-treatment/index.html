<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <link rel="shortcut icon" href="../../../img/favicon.ico">

    <title>CredentialTreatmentAdapter - zend-authentication</title>

    <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.018/css/hack.min.css">
    <link href="//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Libre+Baskerville:400,400italic,700&subset=latin,latin-ext" rel="stylesheet" type="text/css">
    <link href="../../../css/base.css" rel="stylesheet">
    <link href="../../../css/zf-web.css" rel="stylesheet">
    <link href="../../../css/zf.css" rel="stylesheet">
    <link href="../../../css/prism-zf.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Open Sans', 'PT Sans']
        }
    });
    </script>

    
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <span class="navbar-brand">
              <a class="logo-link" href="http://framework.zend.com" data-toggle="tooltip" data-placement="bottom" title="Zend Framework"><img src="../../../img/zf-logo-mark.png" height="28" alt="Zend Framework" /></a>
              <a href="../../..">zend-authentication</a>
            </span>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../../..">Home</a>
                    </li>
                
                
                
                    <li >
                        <a href="../../../intro/">Intro</a>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Adapters <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../intro/">Intro</a>
</li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">DbTable</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../intro/">Intro</a>
</li>

        
            
<li class="active">
    <a href="./">CredentialTreatmentAdapter</a>
</li>

        
            
<li >
    <a href="../callback-check/">CallbackCheck</a>
</li>

        
    </ul>
  </li>

                        
                            
<li >
    <a href="../../digest/">Digest</a>
</li>

                        
                            
<li >
    <a href="../../http/">HTTP</a>
</li>

                        
                            
<li >
    <a href="../../ldap/">LDAP</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../../../storage/">Identity Persistence</a>
                    </li>
                
                
                
                    <li >
                        <a href="../../../validator/">Validation</a>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" class="component-toggle" data-toggle="tooltip" data-placement="bottom" title="Show component list">
                        <i class="fa fa-book"></i> Components
                    </a>
                </li>

                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li>
                        <a href="https://github.com/zendframework/zend-authentication">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

    <!-- content:begin -->
    <div id="page-top" class="container docs">
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#dbtable-credential-treatment">DbTable Credential Treatment</a></li>
        
            <li><a href="#configuration-options">Configuration Options</a></li>
        
            <li><a href="#basic-usage">Basic Usage</a></li>
        
            <li><a href="#advanced-usage">Advanced Usage</a></li>
        
    
    </ul>

    
    <ul class="pager hidden-print">
      <li class="previous">
        <a rel="prev" href="../intro/"><i class="fa fa-arrow-left"></i> Previous</a>
      </li>
      <li class="next">
        <a rel="next" href="../callback-check/">Next <i class="fa fa-arrow-right"></i></a>
      </li>
    </ul>
    
</div></div>
        <div class="col-md-9" role="main">

<ol class="breadcrumb" role="navigation" aria-label="breadcrumbs navigation">
  <li><a href="../../..">Docs</a> &raquo;</li>
  
    
      
        <li>Adapters &raquo;</li>
      
    
      
        <li>DbTable &raquo;</li>
      
    
  
  <li class="active">CredentialTreatmentAdapter</li>
</ol>

<h1 id="dbtable-credential-treatment">DbTable Credential Treatment</h1>
<p><code>Zend\Authentication\Adapter\DbTable\CredentialTreatmentAdapter</code> will execute a
SQL query containing the provided identity and credentials, passing the
credentials to a <em>credential treatment</em> function defined on the RDBMS server;
if an identity is returned, authentication succeeds. Common credential
treatments include <code>MD5()</code> and <code>PASSWORD()</code>.</p>
<h2 id="configuration-options">Configuration Options</h2>
<p>The available configuration options include:</p>
<ul>
<li><code>tableName</code>: This is the name of the database table that contains the
  authentication credentials, and against which the database authentication
  query is performed.</li>
<li><code>identityColumn</code>: This is the name of the database table column used to
  represent the identity.  The identity column must contain unique values, such
  as a username or e-mail address.</li>
<li><code>credentialColumn</code>: This is the name of the database table column used to
  represent the credential. Under a simple identity and password authentication
  scheme, the credential value corresponds to the password. See also the
  <code>credentialTreatment</code> option.</li>
<li><code>credentialTreatment</code>: In many cases, passwords and other sensitive data
  are encrypted, hashed, encoded, obscured, salted or otherwise treated through
  some function or algorithm. By specifying a parameterized treatment string
  with this method, such as '<code>MD5(?)</code>' or '<code>PASSWORD(?)</code>', a developer may
  apply such arbitrary SQL upon input credential data. Since these functions
  are specific to the underlying RDBMS, check the database manual for the
  availability of such functions for your database system.</li>
</ul>
<h2 id="basic-usage">Basic Usage</h2>
<p>As explained above, the
<code>Zend\Authentication\Adapter\DbTable\CredentialTreatmentAdapter</code> constructor
requires an instance of <code>Zend\Db\Adapter\Adapter</code> that serves as the database
connection to which the authentication adapter instance is bound. First, the
database connection should be created.</p>
<p>The following code creates an adapter for an in-memory database, creates a
simple table schema, and inserts a row against which we can perform an
authentication query later. This example requires the PDO SQLite extension to
be available:</p>
<pre class="codehilite"><code class="language-php">use Zend\Db\Adapter\Adapter as DbAdapter;

// Create a SQLite database connection
$dbAdapter = new DbAdapter([
    'driver'   =&gt; 'Pdo_Sqlite',
    'database' =&gt; 'data/users.db',
]);

// Build a simple table creation query
$sqlCreate = 'CREATE TABLE [users] ('
    . '[id] INTEGER  NOT NULL PRIMARY KEY, '
    . '[username] VARCHAR(50) UNIQUE NOT NULL, '
    . '[password] VARCHAR(32) NULL, '
    . '[real_name] VARCHAR(150) NULL)';

// Create the authentication credentials table
$dbAdapter-&gt;query($sqlCreate);

// Build a query to insert a row for which authentication may succeed
$sqlInsert = &quot;INSERT INTO users (username, password, real_name) &quot;
    . &quot;VALUES ('my_username', 'my_password', 'My Real Name')&quot;;

// Insert the data
$dbAdapter-&gt;query($sqlInsert);</code></pre>


<p>With the database connection and table data available, an instance of
<code>Zend\Authentication\Adapter\DbTable\CredentialTreatmentAdapter</code> may be
created. Configuration option values may be passed to the constructor or
deferred as parameters to setter methods after instantiation:</p>
<pre class="codehilite"><code class="language-php">use Zend\Authentication\Adapter\DbTable\CredentialTreatmentAdapter as AuthAdapter;

// Configure the instance with constructor parameters:
$authAdapter = new AuthAdapter(
    $dbAdapter,
    'users',
    'username',
    'password'
);

// Or configure the instance with setter methods:
$authAdapter = new AuthAdapter($dbAdapter);

$authAdapter
    -&gt;setTableName('users')
    -&gt;setIdentityColumn('username')
    -&gt;setCredentialColumn('password');</code></pre>


<p>At this point, the authentication adapter instance is ready to accept
authentication queries. In order to formulate an authentication query, the
input credential values are passed to the adapter prior to calling the
<code>authenticate()</code> method:</p>
<pre class="codehilite"><code class="language-php">// Set the input credential values (e.g., from a login form):
$authAdapter
    -&gt;setIdentity('my_username')
    -&gt;setCredential('my_password');

// Perform the authentication query, saving the result
$result = $authAdapter-&gt;authenticate();</code></pre>


<p>In addition to the availability of the <code>getIdentity()</code> method upon the
authentication result object, <code>Zend\Authentication\Adapter\DbTable\CredentialTreatmentAdapter</code>
also supports retrieving the table row upon authentication success:</p>
<pre class="codehilite"><code class="language-php">// Print the identity:
echo $result-&gt;getIdentity() . &quot;\n\n&quot;;

// Print the result row:
print_r($authAdapter-&gt;getResultRowObject());

/* Output:
my_username

Array
(
    [id] =&gt; 1
    [username] =&gt; my_username
    [password] =&gt; my_password
    [real_name] =&gt; My Real Name
)
*/</code></pre>


<p>Since the table row contains the credential value, it is important to secure
the values against unintended access.</p>
<p>When retrieving the result object, we can either specify what columns to
return, or what columns to omit:</p>
<pre class="codehilite"><code class="language-php">// Specify the columns to return:
$columnsToReturn = [
    'id',
    'username',
    'real_name',
];
print_r($authAdapter-&gt;getResultRowObject($columnsToReturn));

/* Output:

Array
(
   [id] =&gt; 1
   [username] =&gt; my_username
   [real_name] =&gt; My Real Name
)
*/

// Or specify the columns to omit; when using this approach,
// pass a null value as the first argument to getResultRowObject():
$columnsToOmit = ['password'];
print_r($authAdapter-&gt;getResultRowObject(null, $columnsToOmit);

/* Output:

Array
(
   [id] =&gt; 1
   [username] =&gt; my_username
   [real_name] =&gt; My Real Name
)
*/</code></pre>


<h2 id="advanced-usage">Advanced Usage</h2>
<p>While the primary purpose of zend-authentication is <strong>authentication</strong> and not
<strong>authorization</strong>, there are a few instances and problems that toe the line
between which domain they fit.  Depending on how you've decided to explain your
problem, it sometimes makes sense to solve what could look like an
authorization problem within the authentication adapter.</p>
<p>Below are a few examples showing how you can provide compound criteria to the
credential treatment to solve more complex problems.</p>
<h3 id="check-for-compromised-user">Check for compromised user</h3>
<p>In this scenario, we use the credential treatment <code>MD5()</code>, but also check to see
that the user has not been flagged as "compromised", which is a potential value
of the <code>status</code> field for the user record.</p>
<pre class="codehilite"><code class="language-php">use Zend\Authentication\Adapter\DbTable\CredentialTreatmentAdapter as AuthAdapter;

// The status field value of an account is not equal to &quot;compromised&quot;
$adapter = new AuthAdapter(
    $db,
    'users',
    'username',
    'password',
    'MD5(?) AND status != &quot;compromised&quot;'
);</code></pre>


<h3 id="check-for-active-user">Check for active user</h3>
<p>In this example, we check to see if a user is active; this may be necessary
if we require a user to login once over X days, or if we need to ensure that
they have followed a verification process.</p>
<pre class="codehilite"><code class="language-php">use Zend\Authentication\Adapter\DbTable\CredentialTreatmentAdapter as AuthAdapter;

// The active field value of an account is equal to &quot;TRUE&quot;
$adapter = new AuthAdapter(
    $db,
    'users',
    'username',
    'password',
    'MD5(?) AND active = &quot;TRUE&quot;'
);</code></pre>


<h3 id="salting">Salting</h3>
<p>Another scenario can be the implementation of a salting mechanism. Salting
refers to a technique for improving application security; it's based on the
idea that concatenating a random string to every password makes it impossible
to accomplish a successful brute force attack on the database using
pre-computed hash values from a dictionary.</p>
<p>Let's modify our table to store our salt string:</p>
<pre class="codehilite"><code class="language-php">$sqlAlter = &quot;ALTER TABLE [users] &quot;
    . &quot;ADD COLUMN [password_salt] &quot;
    . &quot;AFTER [password]&quot;;</code></pre>


<p>Salts should be created <em>for each user</em> using a cryptographically sound pseudo-random number generator (CSPRNG). PHP 7 provides an implementation via <code>random_bytes</code>:</p>
<pre class="codehilite"><code class="language-php">$salt = random_bytes(32);</code></pre>


<p>For earlier versions of PHP, use <a href="https://github.com/zendframework/zend-math">zend-math</a>'s <code>Zend\Math\Rand</code>:</p>
<pre class="codehilite"><code class="language-php">use Zend\Math\Rand;

$salt = Rand::getBytes(32, true);</code></pre>


<p>(As of zend-math 2.7.0, <code>Rand::getBytes()</code> will proxy to <code>random_bytes()</code> when
running under PHP 7, making it a good, forwards-compatible solution for your
application.)</p>
<p>Do this each time you create a user or update their password, and store it in the
<code>password_salt</code> column you created.</p>
<p>Now let's build the adapter:</p>
<pre class="codehilite"><code class="language-php">$adapter = new AuthAdapter(
$db,
    'users',
    'username',
    'password',
    &quot;MD5(CONCAT('staticSalt', ?, password_salt))&quot;
);</code></pre>


<blockquote>
<h4 id="salt-security">Salt security</h4>
<p>You can improve security even more by using a static salt value hard coded
into your application. In the case that your database is compromised (e.g.
by an SQL injection attack) but your web server is intact, your data is still
unusable for the attacker.</p>
<p>Define the salt as an environment variable on your web server, and then
either pull it from the environment, or assign it to a constant during
bootstrap; pass the value to the credential treatment when creating your
adapter.</p>
<p>The above example uses the value "staticSalt"; you should create a better
salt using one of the methods outlined above.</p>
</blockquote>
<h3 id="alter-the-sql-select-directly">Alter the SQL select directly</h3>
<p>Another alternative is to use the <code>getDbSelect()</code> method to retrieve the
<code>Zend\Db\Sql\Select</code> instance associated with the adapter and modify it. (The
method is common to all <code>Zend\Authentication\Adapter\DbTable</code> adapters.) The
<code>Select</code> instance is consumed by the <code>authenticate()</code> routine when building the
SQL to execute on the RDMBS server.  It is important to note that this method
will always return the same <code>Select</code> instance regardless if <code>authenticate()</code>
has been called or not; identity and credential values are passed to the
instance as placeholders.</p>
<p>This approach allows you to define a generic credential treatment, and then add
criteria later, potentially based on specific paths through the application.</p>
<p>The following uses the second example in this section, adding another <code>WHERE</code>
clause to determine if the user is active in the system.</p>
<pre class="codehilite"><code class="language-php">// Create a basic adapter, with only an MD5() credential treatment:
$adapter = new AuthAdapter(
    $db,
    'users',
    'username',
    'password',
    'MD5(?)'
);

// Now retrieve the Select instance and modify it:
$select = $adapter-&gt;getDbSelect();
$select-&gt;where('active = &quot;TRUE&quot;');

// Authenticate; this will include &quot;users.active = TRUE&quot; in the WHERE clause:
$adapter-&gt;authenticate();</code></pre>

<hr />


<nav>
  <ul class="pager hidden-print">
    <li class="previous">
      <a rel="prev" href="../intro/"><i class="fa fa-arrow-left"></i> Previous</a>
    </li>
    <li class="next">
      <a rel="next" href="../callback-check/">Next <i class="fa fa-arrow-right"></i></a>
    </li>
  </ul>
</nav>
</div>
        
    </div>
    <!-- content:end -->

    <div id="footerwrap">
    <div class="container">
        <div class="row site-map">
            <div class="col-lg-3">
              <p>
                <strong>Zend Framework</strong><br />
                <a href="http://framework.zend.com/">framework.zend.com</a><br />
                <a href="https://docs.zendframework.com">docs.zendframework.com</a><br />
                <a href="https://packages.zendframework.com">packages.zendframework.com</a><br />
                <a href="https://apigility.org">apigility.org</a><br />
              </p>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 centered">
                <a class="back-to-top" href="#page-top"><i class="fa fa-chevron-circle-up fa-4" aria-hidden="true"></i></a>
            </div>
        </div>

        <div class="spacing"></div>

        <div class="row">
            <div class="col-lg-8">
                <h4>Copyright</h4>
                <div class="hline-w"></div>

                <p>&copy; 2006-2016 by <a href="http://www.zend.com">Zend</a>, a <a href="http://www.roguewave.com/">Rogue Wave Company</a>.</p>
            </div>

            <div class="col-lg-4">
                <h4>Contacts</h4>
                <div class="hline-w"></div>
                <p>
                    <a href="irc://irc.freenode.net/zftalk" class="btn-social btn-outline" alt="IRC" title="IRC"><i class="fa fa-comment"></i></a>
                    <a href="https://github.com/zendframework" class="btn-social btn-outline" alt="Github" title="Github"><i class="fa fa-github"></i></a>
                    <a href="https://twitter.com/zfdevteam" class="btn-social btn-outline" alt="Twitter" title="Twitter"><i class="fa fa-twitter"></i></a>
                </p>
            </div>
        </div>
    </div>
</div>


    <script src="../../../js/jquery-1.10.2.min.js"></script>
    <script src="../../../js/bootstrap-3.0.3.min.js"></script>
    <script src="../../../js/prism-zf.js"></script>

    <script>var base_url = '../../..';</script>
    <script data-main="../../../mkdocs/js/search.js" src="../../../mkdocs/js/require.js"></script>
    <script src="../../../js/base.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    <div class="zf-components">
  <div class="zf-components-grid">
    <div class="zf-logo">
      <a href="http://framework.zend.com" data-toggle="tooltip" data-placement="bottom" title="Go to the ZF homepage"><img src="../../../img/zf-logo-mark.png" alt="Zend Framework" width="250" /></a>
    </div>

    <div class="component-list"></div>

    <p class="zf-components-rollup"><a href="#">Hide list</a></p>
  </div>
</div>

    <script>
  // Prepare the component list dropdown for display
  $(function () {
    var components = $(".zf-components"),
        componentList = components.find(".component-list"),
        sidebar = $(".bs-sidebar.affix"),
        sidebarInitialPos = sidebar.css("position"),
        hidden,
        componentToggle = $(".component-toggle"),
        navbar = $(".navbar-fixed-top"),
        rollUpLink = $(".zf-components-rollup a");

    // Initial setup on document load
    components.insertBefore(navbar);
    $(".zf-logo a").tooltip();
    componentToggle.tooltip();
    rollUpLink.attr({ href: "#", alt: "Hide component list" });

    // Cast initial sidebar position value
    if (undefined === sidebarInitialPos) {
      sidebarInitialPos = "fixed";
    }

    // Setup onclick events to toggle list
    componentToggle.click(toggleComponentList);
    rollUpLink.click(toggleComponentList);

    // Toggle the component list display
    function toggleComponentList(event) {
      event.preventDefault();

      if (hidden === undefined) {
        // Not loaded yet; load and display.
        loadComponentList();
        return;
      }

      if (hidden) {
        // Hidden; display.
        showComponentList();
        return;
      }

      // Currently visible; hide
      hideComponentList();
    }

    // Show the component list
    function showComponentList() {
      navbar.css({position: "relative"});
      sidebar.css({position: "relative"});
      components
        .css({"margin-top": "-" + components.outerHeight() + "px"})
        .show()
        .animate({"margin-top": 0}, {
          complete: function () {
            componentToggle
              .data("placement", "top")
              .attr("data-original-title", "Hide component list");
            hidden = false;
          },
          queue: false
        });
    }

    // Hide the component list
    function hideComponentList() {
      components.animate({"margin-top": "-" + components.outerHeight() + "px"}, {
        complete: function () {
          navbar.css({position: "fixed"});
          sidebar.css({position: sidebarInitialPos});
          componentToggle
            .data("placement", "bottom")
            .attr("data-original-title", "Show component list");
          components.hide();
          hidden = true;
        },
        queue: false
      });
      sidebar.animate({ top: sidebarInitialTop + "px" }, { queue: false});
    }

    // Inject a component into the componet list DOM.
    function injectComponent(index, component) {
      componentList.append('<div class="component"><h4><a href="' + component.url + '">' + component.name + '</a></h4><p>' + component.description + '</p></div>');
    }

    // Parse the component list, build the DOM, and display it.
    function parseComponentList(components) {
      $.each(components, injectComponent);
      showComponentList();
    }

    // Fetch the component list and display it.
    function loadComponentList () {
      $.ajax({
        url: "//docs.zendframework.com/zf-mkdoc-theme/scripts/zf-component-list.json",
        dataType: "text json",
        success: parseComponentList,
        error: function (e) {
          console.log("Error occurred with XHR call", e);
        }
      });
    }
  });
</script>
    </body>

</html>
